<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challenge Cup SSIAP - Multijoueur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap');

        * {
            font-family: 'Poppins', sans-serif;
        }

        .timer-warning {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            animation: confetti-fall 3s linear forwards;
        }

        /* Protection scroll pour stagiaires */
        body.trainee-connected {
            overflow: hidden !important;
            position: fixed !important;
            width: 100% !important;
            height: 100% !important;
            top: 0 !important;
            left: 0 !important;
        }

        body.trainee-connected #trainee-login {
            display: none !important;
        }

        /* Styles pour matching */
        .matching-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .matching-item {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .matching-item.selected {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }

        .matching-item.matched {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Styles pour sequence */
        .sequence-item {
            cursor: move;
            user-select: none;
        }

        .sequence-item.dragging {
            opacity: 0.5;
        }

        /* Styles pour quiz-multi */
        .checkbox-option {
            cursor: pointer;
        }

        .checkbox-option input[type="checkbox"] {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen text-white">

<!-- Confetti Container -->
<div id="confetti-container" class="fixed inset-0 pointer-events-none z-50"></div>

<!-- √âCRAN DE CONNEXION -->
<div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white/10 backdrop-blur-lg p-8 rounded-3xl shadow-2xl max-w-md w-full border border-white/20">
        <h1 class="text-4xl font-bold text-center mb-2">üèÜ Challenge Cup</h1>
        <p class="text-center text-purple-200 mb-8">SSIAP Formation</p>
        <div class="space-y-4">
            <button onclick="showSupervisorLogin()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transition">
                üë®‚Äçüè´ Superviseur
            </button>
            <button onclick="showTraineeLogin()" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transition">
                üë§ Stagiaire
            </button>
        </div>
    </div>
</div>

<!-- CONNEXION SUPERVISEUR -->
<div id="supervisor-login" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="bg-white/10 backdrop-blur-lg p-8 rounded-3xl shadow-2xl max-w-md w-full border border-white/20">
        <h2 class="text-3xl font-bold mb-6">Connexion Superviseur</h2>
        <input type="password" id="supervisor-password" placeholder="Mot de passe" class="w-full px-4 py-3 rounded-xl bg-white/20 border border-white/30 text-white placeholder-white/50 mb-4 text-lg">
        <div id="supervisor-error" class="hidden text-red-300 mb-4 text-sm"></div>
        <button onclick="loginSupervisor()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-xl font-bold hover:shadow-lg transition">
            Se connecter
        </button>
        <button onclick="showLoginScreen()" class="w-full mt-3 bg-white/10 text-white py-3 rounded-xl font-semibold hover:bg-white/20 transition">
            Retour
        </button>
    </div>
</div>

<!-- CONNEXION STAGIAIRE -->
<div id="trainee-login" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white/10 backdrop-blur-lg p-8 rounded-3xl shadow-2xl max-w-md w-full border border-white/20">
        <h2 class="text-3xl font-bold mb-2">Connexion Stagiaire</h2>
        <p class="text-purple-200 mb-6 text-sm">Entrez le code PIN de votre √©quipe</p>
        <input type="text" id="trainee-pin" placeholder="Code PIN" maxlength="6" inputmode="numeric" class="w-full px-4 py-3 rounded-xl bg-white/20 border border-white/30 text-white placeholder-white/50 mb-4 text-2xl text-center font-bold tracking-widest">
        <div id="trainee-error" class="hidden text-red-300 mb-4 text-sm"></div>
        <button onclick="loginTrainee()" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white py-3 rounded-xl font-bold hover:shadow-lg transition">
            Se connecter
        </button>
        <button onclick="showLoginScreen()" class="w-full mt-3 bg-white/10 text-white py-3 rounded-xl font-semibold hover:bg-white/20 transition">
            Retour
        </button>
    </div>
</div>

<!-- DASHBOARD SUPERVISEUR -->
<div id="supervisor-dashboard" class="hidden min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">üèÜ Challenge Cup SSIAP</h1>
            <button onclick="logout()" class="bg-red-500 px-6 py-2 rounded-xl font-semibold hover:bg-red-600 transition">
                D√©connexion
            </button>
        </div>

        <!-- QR Code Connexion Stagiaires -->
        <div class="bg-white/10 backdrop-blur-lg p-6 rounded-2xl border border-white/20 mb-6 text-center">
            <h2 class="text-2xl font-bold mb-4">üì± Connexion Stagiaires</h2>
            <p class="text-purple-200 mb-4">Scannez ce QR code pour rejoindre la session</p>
            <div id="qrcode-container" class="inline-block p-4 bg-white rounded-xl mb-4"></div>
            <p class="text-sm text-purple-200">Ou utilisez le code PIN de votre √©quipe</p>
        </div>

        <!-- Formulaire Cr√©ation √âquipe -->
        <div class="bg-white/10 backdrop-blur-lg p-6 rounded-2xl border border-white/20 mb-6">
            <h2 class="text-2xl font-bold mb-4">‚ûï Cr√©er une √©quipe</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="team-name" placeholder="Nom de l'√©quipe" class="px-4 py-2 rounded-xl bg-white/20 border border-white/30 text-white placeholder-white/50">
                <select id="team-level" class="px-4 py-2 rounded-xl bg-white/20 border border-white/30 text-white">
                    <option value="1">SSIAP 1</option>
                    <option value="2">SSIAP 2</option>
                    <option value="3">SSIAP 3</option>
                </select>
                <button onclick="addTeam()" class="bg-gradient-to-r from-green-500 to-emerald-500 px-6 py-2 rounded-xl font-bold hover:shadow-lg transition">
                    Cr√©er
                </button>
            </div>
        </div>

        <!-- Liste des √©quipes -->
        <div class="bg-white/10 backdrop-blur-lg p-6 rounded-2xl border border-white/20 mb-6">
            <h2 class="text-2xl font-bold mb-4">üë• √âquipes</h2>
            <div id="teams-list" class="space-y-3"></div>
        </div>

        <!-- Boutons de contr√¥le -->
        <div class="flex gap-4">
            <button onclick="startGame()" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-500 px-8 py-4 rounded-xl font-bold text-xl hover:shadow-lg transition">
                üéÆ D√©marrer le jeu
            </button>
        </div>
    </div>
</div>

<!-- √âCRAN PROJECTEUR (Questions visibles) -->
<div id="projector-screen" class="hidden min-h-screen p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Barre de progression -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-2">
                <span class="text-lg font-semibold">Question <span id="projector-question-num">1</span>/<span id="projector-total-questions">20</span></span>
                <span class="text-lg font-semibold">Coffre: <span id="projector-box-name">-</span></span>
            </div>
            <div class="w-full bg-white/20 rounded-full h-3">
                <div id="projector-progress" class="bg-gradient-to-r from-green-400 to-emerald-500 h-3 rounded-full transition-all" style="width: 0%"></div>
            </div>
        </div>

        <!-- Timer -->
        <div class="text-center mb-8">
            <div id="projector-timer" class="text-8xl font-bold">30</div>
            <div class="text-xl text-purple-200">secondes restantes</div>
        </div>

        <!-- Question -->
        <div class="bg-white/10 backdrop-blur-lg p-8 rounded-3xl border border-white/20 mb-6">
            <h2 class="text-4xl font-bold mb-4 text-center" id="projector-question-title">Question</h2>
            <p class="text-2xl text-center mb-8" id="projector-question-text">-</p>
        </div>

        <!-- Options de r√©ponse -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="projector-options">
            <!-- Options g√©n√©r√©es dynamiquement -->
        </div>

        <!-- Statut √©quipes qui ont r√©pondu -->
        <div class="mt-8 bg-white/10 backdrop-blur-lg p-6 rounded-2xl border border-white/20">
            <h3 class="text-xl font-bold mb-4">üìä R√©ponses: <span id="projector-answers-count">0</span>/<span id="projector-teams-count">0</span></h3>
            <div id="projector-teams-status" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
        </div>
    </div>
</div>

<!-- √âCRAN CORRECTION -->
<div id="correction-screen" class="hidden min-h-screen p-8">
    <div class="max-w-6xl mx-auto">
        <h2 class="text-5xl font-bold text-center mb-8">üìä R√©sultats</h2>

        <div class="bg-white/10 backdrop-blur-lg p-8 rounded-3xl border border-white/20 mb-6">
            <p class="text-3xl text-center mb-6" id="correction-question">Question</p>
            <div class="text-center mb-6">
                <span class="text-2xl">‚úÖ Bonne r√©ponse: </span>
                <span class="text-3xl font-bold text-green-400" id="correction-answer">-</span>
            </div>
            <div class="text-center text-purple-200 text-lg" id="correction-explanation">-</div>
        </div>

        <!-- Classement -->
        <div class="bg-white/10 backdrop-blur-lg p-6 rounded-2xl border border-white/20 mb-6">
            <h3 class="text-2xl font-bold mb-4">üèÜ Classement</h3>
            <div id="correction-leaderboard" class="space-y-3"></div>
        </div>

        <button onclick="nextQuestion()" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 px-8 py-4 rounded-xl font-bold text-xl hover:shadow-lg transition">
            Question suivante ‚û°Ô∏è
        </button>
    </div>
</div>

<!-- √âCRAN STAGIAIRE (En attente) -->
<div id="trainee-waiting" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="text-center">
        <div class="text-8xl mb-6 animate-bounce">‚è≥</div>
        <h2 class="text-4xl font-bold mb-4">En attente...</h2>
        <p class="text-xl text-purple-200">Le superviseur va bient√¥t d√©marrer le jeu</p>
    </div>
</div>

<!-- √âCRAN STAGIAIRE (R√©ponse) -->
<div id="trainee-answer" class="hidden min-h-screen p-4">
    <div class="max-w-2xl mx-auto">
        <!-- En-t√™te -->
        <div class="text-center mb-8">
            <div class="text-6xl font-bold mb-2" id="trainee-timer">30</div>
            <div class="text-xl text-purple-200">secondes</div>
        </div>

        <!-- Info √©quipe -->
        <div class="bg-white/10 backdrop-blur-lg p-4 rounded-2xl border border-white/20 mb-6 text-center">
            <div class="text-2xl font-bold" id="trainee-team-name">Mon √©quipe</div>
            <div class="text-lg text-purple-200">Score: <span id="trainee-score">0</span> pts</div>
        </div>

        <!-- Message -->
        <div class="text-center mb-6">
            <p class="text-2xl font-bold">Question <span id="trainee-question-num">1</span>/<span id="trainee-total-questions">20</span></p>
            <p class="text-lg text-purple-200">S√©lectionnez votre r√©ponse</p>
        </div>

        <!-- Boutons de r√©ponse -->
        <div class="grid grid-cols-1 gap-4" id="trainee-options">
            <!-- Options g√©n√©r√©es dynamiquement -->
        </div>

        <!-- Bouton valider -->
        <button id="trainee-submit-btn" onclick="submitAnswer()" disabled class="w-full mt-6 bg-gradient-to-r from-green-500 to-emerald-500 px-8 py-4 rounded-xl font-bold text-xl hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
            ‚úì Valider ma r√©ponse
        </button>
    </div>
</div>

<!-- √âCRAN STAGIAIRE (R√©sultat) -->
<div id="trainee-result" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="text-center">
        <div class="text-9xl mb-6" id="trainee-result-icon">‚úì</div>
        <h2 class="text-5xl font-bold mb-6" id="trainee-result-title">Bonne r√©ponse !</h2>
        <div class="text-3xl mb-4">
            <span id="trainee-result-points">+100</span> points
        </div>
        <div class="text-2xl text-purple-200">
            Score total: <span id="trainee-result-total" class="font-bold">100</span> pts
        </div>
    </div>
</div>

<!-- √âCRAN VICTOIRE FINALE -->
<div id="final-screen" class="hidden min-h-screen p-8">
    <div class="max-w-4xl mx-auto text-center">
        <div class="text-9xl mb-6">üèÜ</div>
        <h1 class="text-6xl font-bold mb-8">Challenge Cup Termin√© !</h1>

        <div class="bg-white/10 backdrop-blur-lg p-8 rounded-3xl border border-white/20 mb-8">
            <h2 class="text-4xl font-bold mb-6">ü•á Classement Final</h2>
            <div id="final-leaderboard" class="space-y-4"></div>
        </div>

        <button onclick="restartGame()" class="bg-gradient-to-r from-purple-500 to-pink-500 px-12 py-4 rounded-xl font-bold text-xl hover:shadow-lg transition">
            üîÑ Nouvelle partie
        </button>
    </div>
</div>

<script>
// Configuration Firebase (m√™me DB que qcm-sst)
const firebaseConfig = {
    apiKey: "AIzaSyAZLBDZIaPp3GrXuVz4fPiK91JhLEqXPs0",
    authDomain: "jeu-sst-v1-291025.firebaseapp.com",
    databaseURL: "https://jeu-sst-v1-291025-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "jeu-sst-v1-291025",
    storageBucket: "jeu-sst-v1-291025.firebasestorage.app",
    messagingSenderId: "57462613537",
    appId: "1:57462613537:web:6178195b2f4f08fbaa2560"
};

// Initialiser Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
console.log('üî• Firebase initialis√©');

// Variables globales
let sessionId = null;
let userRole = null; // 'supervisor' ou 'trainee'
let teamId = null;
let teamName = null;
let currentGameIndex = 0;
let timerInterval = null;
let answersListener = null;
let selectedAnswer = null;

// Variables pour les nouveaux types de jeux
let selectedAnswers = []; // Pour quiz-multi
let matchingPairs = []; // Pour matching
let sequenceOrder = []; // Pour sequence
let selectedLeft = null; // Pour matching
let selectedRight = null; // Pour matching

// Mot de passe superviseur
const SUPERVISOR_PASSWORD = '3215';

// Questions par niveau SSIAP - Tous types de jeux
const BOXES_DATA = {
    1: [ // SSIAP 1 - 20 questions vari√©es
        // Le Feu (5 questions)
        {
            type: "quiz",
            title: "Le Feu",
            icon: "üî•",
            color: "from-red-500 to-orange-700",
            question: "Quels sont les 3 √©l√©ments n√©cessaires pour qu'un feu se d√©clare ?",
            options: [
                "Combustible, Comburant, √ânergie d'activation",
                "Chaleur, Fum√©e, Flamme",
                "Oxyg√®ne, Azote, Hydrog√®ne",
                "Bois, Papier, Tissu"
            ],
            correctAnswer: 0,
            explanation: "Le triangle du feu est compos√© de 3 √©l√©ments : combustible, comburant et √©nergie d'activation.",
            timeLimit: 45,
            points: 100
        },
        {
            type: "matching",
            title: "Classes de Feu",
            icon: "üî•",
            color: "from-red-500 to-orange-700",
            question: "Associez chaque classe de feu avec le bon type de combustible :",
            pairs: [
                { left: "Classe A", right: "Solides (bois, papier, tissu)" },
                { left: "Classe B", right: "Liquides ou solides liqu√©fiables" },
                { left: "Classe C", right: "Gaz" },
                { left: "Classe D", right: "M√©taux" }
            ],
            explanation: "Les classes de feu sont d√©finies selon la nature du combustible.",
            timeLimit: 60,
            points: 120
        },
        {
            type: "quiz",
            title: "Le Feu",
            icon: "üî•",
            color: "from-red-500 to-orange-700",
            question: "Quel est le comburant le plus courant dans un incendie ?",
            options: [
                "L'oxyg√®ne de l'air",
                "Le dioxyde de carbone",
                "L'azote",
                "L'eau"
            ],
            correctAnswer: 0,
            explanation: "L'oxyg√®ne de l'air (21%) est le comburant le plus courant dans les incendies.",
            timeLimit: 35,
            points: 100
        },
        {
            type: "matching",
            title: "Modes de Propagation",
            icon: "üî•",
            color: "from-red-500 to-orange-700",
            question: "Associez chaque mode de propagation avec sa d√©finition :",
            pairs: [
                { left: "Conduction", right: "Par contact direct" },
                { left: "Convection", right: "Par d√©placement de gaz chauds" },
                { left: "Rayonnement", right: "Par ondes √©lectromagn√©tiques" },
                { left: "Projection", right: "Par projections de mati√®res" }
            ],
            explanation: "Il existe 4 modes de propagation de la chaleur lors d'un incendie.",
            timeLimit: 60,
            points: 120
        },
        {
            type: "true-false",
            title: "Le Feu",
            icon: "üî•",
            color: "from-red-500 to-orange-700",
            question: "La concentration minimale d'oxyg√®ne n√©cessaire √† la combustion est de 18% ?",
            options: ["Vrai", "Faux"],
            correctAnswer: 0,
            explanation: "Vrai. En dessous de 18% d'oxyg√®ne, la combustion s'arr√™te progressivement.",
            timeLimit: 30,
            points: 100
        },
        // SSI et Extincteurs (5 questions vari√©es)
        {
            type: "quiz",
            title: "Classes de Feu",
            icon: "üìã",
            color: "from-blue-500 to-indigo-700",
            question: "Un feu de classe B concerne :",
            options: [
                "Les liquides et solides liqu√©fiables",
                "Les solides uniquement",
                "Les gaz uniquement",
                "Les m√©taux uniquement"
            ],
            correctAnswer: 0,
            explanation: "Les feux de classe B concernent les liquides inflammables (essence, huile) et solides liqu√©fiables.",
            timeLimit: 40,
            points: 100
        },
        {
            type: "matching",
            title: "Agents Extincteurs",
            icon: "üìã",
            color: "from-blue-500 to-indigo-700",
            question: "Associez chaque agent extincteur avec son utilisation principale :",
            pairs: [
                { left: "Eau pulv√©ris√©e", right: "Feux de classe A" },
                { left: "Poudre ABC", right: "Feux A, B, C polyvalent" },
                { left: "CO2", right: "Feux √©lectriques et B" },
                { left: "Mousse", right: "Feux de classe B" }
            ],
            explanation: "Chaque agent extincteur a des propri√©t√©s sp√©cifiques adapt√©es √† certains types de feux.",
            timeLimit: 60,
            points: 120
        },
        {
            type: "sequence",
            title: "Fonctionnement SSI",
            icon: "üìã",
            color: "from-blue-500 to-indigo-700",
            question: "Remettez dans l'ordre les √©tapes du fonctionnement d'un SSI :",
            items: [
                "D√©tection par un d√©tecteur",
                "Transmission au tableau de signalisation",
                "D√©clenchement de l'alarme",
                "Mise en s√©curit√© (d√©senfumage, etc.)"
            ],
            explanation: "Le SSI suit une s√©quence logique de d√©tection √† la mise en s√©curit√©.",
            timeLimit: 60,
            points: 120
        },
        {
            type: "quiz",
            title: "Classes de Feu",
            icon: "üìã",
            color: "from-blue-500 to-indigo-700",
            question: "Un feu de friteuse est un feu de classe :",
            options: [
                "Classe B (liquides)",
                "Classe A (solides)",
                "Classe C (gaz)",
                "Classe D (m√©taux)"
            ],
            correctAnswer: 0,
            explanation: "Un feu de friteuse (huile) est un feu de classe B car il s'agit d'un liquide inflammable.",
            timeLimit: 35,
            points: 100
        },
        {
            type: "true-false",
            title: "S√©curit√© Incendie",
            icon: "üìã",
            color: "from-blue-500 to-indigo-700",
            question: "On peut utiliser de l'eau sur tous les types de feux ?",
            options: ["Vrai", "Faux"],
            correctAnswer: 1,
            explanation: "Faux. L'eau ne doit JAMAIS √™tre utilis√©e sur les feux de liquides, m√©taux ou installations √©lectriques.",
            timeLimit: 30,
            points: 100
        },
        // Moyens d'Extinction et Intervention (5 questions vari√©es)
        {
            type: "quiz",
            title: "Moyens d'Extinction",
            icon: "üßØ",
            color: "from-green-500 to-emerald-700",
            question: "Quel extincteur utiliser sur un feu d'origine √©lectrique ?",
            options: [
                "Extincteur CO2",
                "Extincteur √† eau",
                "Extincteur √† mousse",
                "Extincteur √† eau pulv√©ris√©e"
            ],
            correctAnswer: 0,
            explanation: "Le CO2 est non conducteur et ne laisse pas de r√©sidu, id√©al pour les feux √©lectriques.",
            timeLimit: 40,
            points: 100
        },
        {
            type: "sequence",
            title: "Proc√©dure d'Intervention",
            icon: "üßØ",
            color: "from-green-500 to-emerald-700",
            question: "Ordre d'intervention du SSIAP en cas d'alarme incendie :",
            items: [
                "Lev√©e de doute",
                "Alerte des secours si feu confirm√©",
                "Mise en s√©curit√© des personnes",
                "Premi√®re intervention si possible"
            ],
            explanation: "Cette proc√©dure garantit une intervention m√©thodique et efficace.",
            timeLimit: 60,
            points: 120
        },
        {
            type: "quiz-multi",
            title: "Extincteurs",
            icon: "üßØ",
            color: "from-green-500 to-emerald-700",
            question: "Quelles affirmations sur les extincteurs sont vraies ? (Plusieurs r√©ponses)",
            options: [
                "Distance maximale : 15m",
                "Distance d'utilisation : 2-3m",
                "V√©rification annuelle obligatoire",
                "Poudre ABC : feux A, B et C",
                "Tous sont identiques"
            ],
            correctAnswers: [0, 1, 2, 3],
            explanation: "Les extincteurs doivent √™tre accessibles (15m max), utilis√©s √† bonne distance (2-3m) et v√©rifi√©s annuellement.",
            timeLimit: 70,
            points: 150
        },
        {
            type: "quiz",
            title: "Moyens d'Extinction",
            icon: "üßØ",
            color: "from-green-500 to-emerald-700",
            question: "√Ä quelle distance doit-on se placer pour utiliser un extincteur ?",
            options: [
                "2 √† 3 m√®tres du foyer",
                "Le plus pr√®s possible",
                "5 √† 10 m√®tres minimum",
                "10 m√®tres minimum"
            ],
            correctAnswer: 0,
            explanation: "La distance optimale de 2-3 m√®tres permet efficacit√© et s√©curit√©.",
            timeLimit: 35,
            points: 100
        },
        {
            type: "true-false",
            title: "Moyens d'Extinction",
            icon: "üßØ",
            color: "from-green-500 to-emerald-700",
            question: "Les extincteurs doivent √™tre v√©rifi√©s annuellement ?",
            options: ["Vrai", "Faux"],
            correctAnswer: 0,
            explanation: "Vrai. Les extincteurs doivent √™tre v√©rifi√©s annuellement par un organisme agr√©√©.",
            timeLimit: 30,
            points: 100
        },
        // ERP et Alarme (5 questions vari√©es)
        {
            type: "quiz",
            title: "S√©curit√© Incendie",
            icon: "üè¢",
            color: "from-orange-500 to-yellow-600",
            question: "Qu'est-ce qu'un ERP ?",
            options: [
                "√âtablissement Recevant du Public",
                "√âquipement de R√©duction des P√©rils",
                "Espace R√©serv√© aux Pompiers",
                "√âtage de Rassemblement Principal"
            ],
            correctAnswer: 0,
            explanation: "ERP signifie √âtablissement Recevant du Public (restaurant, magasin, √©cole, etc.).",
            timeLimit: 40,
            points: 100
        },
        {
            type: "matching",
            title: "Types d'ERP",
            icon: "üè¢",
            color: "from-orange-500 to-yellow-600",
            question: "Associez chaque type d'ERP avec son activit√© :",
            pairs: [
                { left: "Type L", right: "Salles de spectacle" },
                { left: "Type M", right: "Magasins" },
                { left: "Type N", right: "Restaurants" },
                { left: "Type O", right: "H√¥tels" }
            ],
            explanation: "Chaque type d'ERP correspond √† une activit√© sp√©cifique.",
            timeLimit: 60,
            points: 120
        },
        {
            type: "quiz",
            title: "S√©curit√© Incendie",
            icon: "üè¢",
            color: "from-orange-500 to-yellow-600",
            question: "√Ä partir de combien de personnes un ERP est-il de 1√®re cat√©gorie ?",
            options: [
                "Plus de 1500 personnes",
                "Plus de 1000 personnes",
                "Plus de 2000 personnes",
                "Plus de 700 personnes"
            ],
            correctAnswer: 0,
            explanation: "Un ERP de 1√®re cat√©gorie accueille plus de 1500 personnes.",
            timeLimit: 40,
            points: 100
        },
        {
            type: "quiz",
            title: "Alarme et Alerte",
            icon: "üö®",
            color: "from-purple-500 to-pink-700",
            question: "Le num√©ro d'appel d'urgence europ√©en est :",
            options: [
                "112",
                "15",
                "18",
                "17"
            ],
            correctAnswer: 0,
            explanation: "Le 112 est le num√©ro d'urgence europ√©en unique, gratuit et accessible partout dans l'UE.",
            timeLimit: 30,
            points: 100
        },
        {
            type: "true-false",
            title: "Alarme et Alerte",
            icon: "üö®",
            color: "from-purple-500 to-pink-700",
            question: "On doit toujours faire une lev√©e de doute AVANT d'appeler les pompiers ?",
            options: ["Vrai", "Faux"],
            correctAnswer: 0,
            explanation: "Vrai. La lev√©e de doute est obligatoire sauf impossibilit√© d'acc√®s √† la zone.",
            timeLimit: 30,
            points: 100
        }
    ],
    2: [ // SSIAP 2 - 20 questions vari√©es
        // Chef d'√âquipe (5 questions vari√©es)
        {
            type: "quiz",
            title: "Chef d'√âquipe",
            icon: "üë®‚Äç‚úàÔ∏è",
            color: "from-red-500 to-orange-700",
            question: "Quelle est la mission principale du chef d'√©quipe SSIAP 2 ?",
            options: [
                "Encadrer et former l'√©quipe de s√©curit√© incendie",
                "Remplacer le directeur de l'√©tablissement",
                "G√©rer uniquement les exercices d'√©vacuation",
                "Contr√¥ler les acc√®s du public"
            ],
            correctAnswer: 0,
            explanation: "Le SSIAP 2 encadre, forme et manage l'√©quipe de s√©curit√© incendie.",
            timeLimit: 45,
            points: 100
        },
        {
            type: "matching",
            title: "Hi√©rarchie SSIAP",
            icon: "üë®‚Äç‚úàÔ∏è",
            color: "from-red-500 to-orange-700",
            question: "Associez chaque niveau SSIAP avec son r√¥le principal :",
            pairs: [
                { left: "SSIAP 1", right: "Agent de s√©curit√© incendie" },
                { left: "SSIAP 2", right: "Chef d'√©quipe" },
                { left: "SSIAP 3", right: "Chef de service" }
            ],
            explanation: "Chaque niveau SSIAP a un r√¥le hi√©rarchique et des missions sp√©cifiques.",
            timeLimit: 60,
            points: 120
        },
        {
            type: "quiz",
            title: "Chef d'√âquipe",
            icon: "üë®‚Äç‚úàÔ∏è",
            color: "from-red-500 to-orange-700",
            question: "Le chef d'√©quipe peut manager combien d'agents SSIAP 1 maximum ?",
            options: [
                "Jusqu'√† 3 agents par √©quipe",
                "Pas de limite",
                "1 agent uniquement",
                "10 agents"
            ],
            correctAnswer: 0,
            explanation: "Une √©quipe SSIAP 2 peut manager jusqu'√† 3 agents SSIAP 1.",
            timeLimit: 40,
            points: 100
        },
        {
            type: "true-false",
            title: "Chef d'√âquipe",
            icon: "üë®‚Äç‚úàÔ∏è",
            color: "from-red-500 to-orange-700",
            question: "En l'absence du SSIAP 3, le chef d'√©quipe SSIAP 2 assure la continuit√© du service ?",
            options: ["Vrai", "Faux"],
            correctAnswer: 0,
            explanation: "Vrai. Le SSIAP 2 assure la continuit√© du service en l'absence du SSIAP 3.",
            timeLimit: 30,
            points: 100
        },
        {
            type: "quiz-multi",
            title: "Missions SSIAP 2",
            icon: "üë®‚Äç‚úàÔ∏è",
            color: "from-red-500 to-orange-700",
            question: "Quelles sont les missions du chef d'√©quipe SSIAP 2 ? (Plusieurs r√©ponses)",
            options: [
                "Former les SSIAP 1",
                "√âtablir les plannings",
                "G√©rer le PC s√©curit√©",
                "Organiser les rondes",
                "Remplacer le maire"
            ],
            correctAnswers: [0, 1, 2, 3],
            explanation: "Le SSIAP 2 forme, planifie, g√®re le PC et organise les rondes de son √©quipe.",
            timeLimit: 70,
            points: 150
        },
        // PC S√©curit√© et Rondes (5 questions vari√©es)
        {
            type: "quiz",
            title: "Gestion PC S√©curit√©",
            icon: "üíª",
            color: "from-cyan-500 to-blue-700",
            question: "Le registre de s√©curit√© doit √™tre tenu :",
            options: [
                "√Ä jour en permanence",
                "Une fois par an",
                "Uniquement en cas de contr√¥le",
                "Uniquement apr√®s un sinistre"
            ],
            correctAnswer: 0,
            explanation: "Le registre de s√©curit√© doit √™tre mis √† jour en permanence et disponible sur demande.",
            timeLimit: 35,
            points: 100
        },
        {
            type: "quiz-multi",
            title: "Rondes de S√©curit√©",
            icon: "üíª",
            color: "from-cyan-500 to-blue-700",
            question: "Lors d'une ronde, que doit v√©rifier le chef d'√©quipe ? (Plusieurs r√©ponses)",
            options: [
                "Issues de secours libres",
                "Moyens de secours en place",
                "Fonctionnement du SSI",
                "Respect des consignes de s√©curit√©",
                "Uniquement les extincteurs"
            ],
            correctAnswers: [0, 1, 2, 3],
            explanation: "Le chef d'√©quipe v√©rifie issues, moyens de secours, SSI et respect des consignes.",
            timeLimit: 70,
            points: 150
        },
        {
            type: "sequence",
            title: "V√©rification Extincteur",
            icon: "üíª",
            color: "from-cyan-500 to-blue-700",
            question: "√âtapes de v√©rification annuelle d'un extincteur :",
            items: [
                "Contr√¥le visuel de l'√©tat g√©n√©ral",
                "V√©rification de la pression/masse",
                "Contr√¥le de l'accessibilit√©",
                "Apposition de l'√©tiquette de contr√¥le"
            ],
            explanation: "Ces √©tapes doivent √™tre suivies pour une v√©rification compl√®te.",
            timeLimit: 60,
            points: 120
        },
        {
            type: "true-false",
            title: "Gestion PC S√©curit√©",
            icon: "üíª",
            color: "from-cyan-500 to-blue-700",
            question: "Le chef d'√©quipe est responsable du bon fonctionnement du poste central de s√©curit√© ?",
            options: ["Vrai", "Faux"],
            correctAnswer: 0,
            explanation: "Vrai. Le chef d'√©quipe est responsable du PC s√©curit√© et de son bon fonctionnement.",
            timeLimit: 30,
            points: 100
        },
        {
            type: "quiz",
            title: "Gestion PC S√©curit√©",
            icon: "üíª",
            color: "from-cyan-500 to-blue-700",
            question: "Le chef d'√©quipe s'assure du bon √©tat des √©quipements de s√©curit√©:",
            options: [
                "Vrai - c'est une de ses missions",
                "Faux - c'est le r√¥le du SSIAP 1",
                "Faux - c'est le r√¥le du SSIAP 3",
                "Uniquement pour les extincteurs"
            ],
            correctAnswer: 0,
            explanation: "Il doit contr√¥ler r√©guli√®rement l'√©tat des √©quipements (extincteurs, RIA, SSI, etc.).",
            timeLimit: 40,
            points: 100
        },
        // Hygi√®ne, S√©curit√© et Formation (5 questions vari√©es)
        {
            type: "quiz",
            title: "Hygi√®ne et S√©curit√©",
            icon: "‚ö†Ô∏è",
            color: "from-red-500 to-rose-700",
            question: "En cas d'accident du travail, le chef d'√©quipe doit :",
            options: [
                "Porter secours et pr√©venir les services comp√©tents",
                "Attendre l'arriv√©e du SSIAP 3",
                "Uniquement remplir un rapport",
                "Ne rien faire"
            ],
            correctAnswer: 0,
            explanation: "Porter secours est prioritaire, puis pr√©venir et documenter l'accident.",
            timeLimit: 35,
            points: 100
        },
        {
            type: "quiz",
            title: "Hygi√®ne et S√©curit√©",
            icon: "‚ö†Ô∏è",
            color: "from-red-500 to-rose-700",
            question: "Le document unique d'√©valuation des risques (DUER) est obligatoire :",
            options: [
                "Dans toutes les entreprises",
                "Uniquement pour les ERP",
                "Uniquement pour les IGH",
                "Uniquement si plus de 50 salari√©s"
            ],
            correctAnswer: 0,
            explanation: "Le DUER est obligatoire dans toutes les entreprises, quelle que soit leur taille.",
            timeLimit: 40,
            points: 100
        },
        {
            type: "quiz-multi",
            title: "Responsabilit√©s SSIAP 2",
            icon: "‚ö†Ô∏è",
            color: "from-red-500 to-rose-700",
            question: "Le chef d'√©quipe est responsable de : (Plusieurs r√©ponses)",
            options: [
                "Contr√¥ler la tenue des agents",
                "Former les SSIAP 1",
                "Organiser les exercices d'√©vacuation",
                "Prendre des d√©cisions en crise",
                "R√©diger les lois"
            ],
            correctAnswers: [0, 1, 2, 3],
            explanation: "Le chef d'√©quipe contr√¥le son √©quipe, forme, organise les exercices et d√©cide en situation d'urgence.",
            timeLimit: 70,
            points: 150
        },
        {
            type: "true-false",
            title: "Exercices et Formation",
            icon: "üìö",
            color: "from-indigo-500 to-purple-700",
            question: "Le chef d'√©quipe peut former les agents SSIAP 1 de son √©quipe ?",
            options: ["Vrai", "Faux"],
            correctAnswer: 0,
            explanation: "Vrai. Le SSIAP 2 assure la formation continue et le recyclage des SSIAP 1.",
            timeLimit: 30,
            points: 100
        },
        {
            type: "sequence",
            title: "D√©clenchement Manuel",
            icon: "üìö",
            color: "from-indigo-500 to-purple-700",
            question: "√âtapes apr√®s l'activation d'un d√©clencheur manuel :",
            items: [
                "Signal transmis au tableau de signalisation",
                "Identification de la zone concern√©e",
                "Lev√©e de doute par le SSIAP",
                "D√©clenchement alarme √©vacuation si n√©cessaire"
            ],
            explanation: "Cette proc√©dure garantit une r√©ponse adapt√©e √† chaque situation.",
            timeLimit: 60,
            points: 120
        },
        // Manipulation SSI (5 questions vari√©es)
        {
            type: "quiz",
            title: "Manipulation SSI",
            icon: "üñ•Ô∏è",
            color: "from-orange-500 to-yellow-600",
            question: "Que signifie CMSI ?",
            options: [
                "Centralisateur de Mise en S√©curit√© Incendie",
                "Centre de Maintien du Syst√®me Incendie",
                "Commande Manuelle du Syst√®me d'Incendie",
                "Central de Mesure de S√©curit√© Int√©rieure"
            ],
            correctAnswer: 0,
            explanation: "Le CMSI centralise et commande la mise en s√©curit√© incendie.",
            timeLimit: 45,
            points: 100
        },
        {
            type: "matching",
            title: "Syst√®mes SSI",
            icon: "üñ•Ô∏è",
            color: "from-orange-500 to-yellow-600",
            question: "Associez chaque sigle avec sa signification :",
            pairs: [
                { left: "CMSI", right: "Centralisateur Mise en S√©curit√©" },
                { left: "DAS", right: "Dispositif Actionn√© de S√©curit√©" },
                { left: "BAES", right: "Bloc Autonome √âclairage S√©curit√©" },
                { left: "SSI", right: "Syst√®me de S√©curit√© Incendie" }
            ],
            explanation: "Ces sigles sont essentiels pour comprendre le syst√®me de s√©curit√© incendie.",
            timeLimit: 60,
            points: 120
        },
        {
            type: "quiz-multi",
            title: "Fonctions CMSI",
            icon: "üñ•Ô∏è",
            color: "from-orange-500 to-yellow-600",
            question: "Quelles fonctions sont assur√©es par un CMSI ? (Plusieurs r√©ponses)",
            options: [
                "Mise en s√©curit√© des ascenseurs",
                "D√©clenchement de l'alarme",
                "Commande du d√©senfumage",
                "Extinction automatique",
                "Gestion des acc√®s"
            ],
            correctAnswers: [0, 1, 2],
            explanation: "Le CMSI g√®re les ascenseurs, l'alarme et le d√©senfumage, mais pas l'extinction automatique.",
            timeLimit: 70,
            points: 150
        },
        {
            type: "quiz",
            title: "Manipulation SSI",
            icon: "üñ•Ô∏è",
            color: "from-orange-500 to-yellow-600",
            question: "La surface maximale d'une zone de d√©tection est de :",
            options: [
                "1600 m¬≤",
                "1000 m¬≤",
                "2000 m¬≤",
                "500 m¬≤"
            ],
            correctAnswer: 0,
            explanation: "Une zone de d√©tection ne doit pas d√©passer 1600 m¬≤.",
            timeLimit: 40,
            points: 100
        },
        {
            type: "quiz-multi",
            title: "Colonnes S√®ches et Humides",
            icon: "üñ•Ô∏è",
            color: "from-orange-500 to-yellow-600",
            question: "Quelles affirmations sur les colonnes sont vraies ? (Plusieurs r√©ponses)",
            options: [
                "Colonne s√®che : vide en temps normal",
                "Colonne humide : toujours en eau",
                "Colonne s√®che : b√¢timents 18m √† 50m",
                "Colonne humide : b√¢timents > 50m",
                "Alimentation par les pompiers"
            ],
            correctAnswers: [0, 1, 2, 3],
            explanation: "Les colonnes s√®ches et humides ont des caract√©ristiques sp√©cifiques selon la hauteur du b√¢timent.",
            timeLimit: 70,
            points: 160
        }
    ],
    3: [ // SSIAP 3 - 20 questions vari√©es
        // Gestion du Service (5 questions vari√©es)
        {
            type: "quiz",
            title: "Chef de Service",
            icon: "üëî",
            color: "from-red-500 to-orange-700",
            question: "Le chef de service SSIAP 3 est responsable :",
            options: [
                "De l'ensemble du service de s√©curit√© incendie",
                "Uniquement d'une √©quipe",
                "Uniquement du PC s√©curit√©",
                "Des sapeurs-pompiers"
            ],
            correctAnswer: 0,
            explanation: "Le SSIAP 3 est responsable de l'ensemble du service de s√©curit√© incendie de l'√©tablissement.",
            timeLimit: 45,
            points: 100
        },
        {
            type: "quiz",
            title: "Effectif",
            icon: "üëî",
            color: "from-red-500 to-orange-700",
            question: "Le SSIAP 3 est obligatoire dans les ERP de :",
            options: [
                "1√®re et 2√®me cat√©gorie avec service de s√©curit√©",
                "Toutes cat√©gories",
                "Uniquement 5√®me cat√©gorie",
                "Jamais obligatoire"
            ],
            correctAnswer: 0,
            explanation: "Le chef de service SSIAP 3 est obligatoire dans les ERP de 1√®re et 2√®me cat√©gorie ayant un service de s√©curit√©.",
            timeLimit: 45,
            points: 100
        },
        {
            type: "quiz-multi",
            title: "Missions SSIAP 3",
            icon: "üëî",
            color: "from-red-500 to-orange-700",
            question: "Quelles sont les missions du chef de service SSIAP 3 ? (Plusieurs r√©ponses)",
            options: [
                "Conseil au chef d'√©tablissement",
                "Management du service",
                "Gestion budg√©taire",
                "Relations avec les autorit√©s",
                "Conduire les bus"
            ],
            correctAnswers: [0, 1, 2, 3],
            explanation: "Le SSIAP 3 a des missions vari√©es : conseil, management, gestion budg√©taire, relations avec les autorit√©s.",
            timeLimit: 70,
            points: 150
        },
        {
            type: "true-false",
            title: "D√©l√©gation",
            icon: "üëî",
            color: "from-red-500 to-orange-700",
            question: "Le chef d'√©tablissement peut d√©l√©guer certaines responsabilit√©s de s√©curit√© au SSIAP 3 par √©crit ?",
            options: ["Vrai", "Faux"],
            correctAnswer: 0,
            explanation: "Vrai. La d√©l√©gation doit √™tre √©crite, pr√©cise et limit√©e aux responsabilit√©s de s√©curit√©.",
            timeLimit: 30,
            points: 100
        },
        {
            type: "matching",
            title: "Niveaux SSIAP",
            icon: "üëî",
            color: "from-red-500 to-orange-700",
            question: "Associez chaque niveau avec ses responsabilit√©s principales :",
            pairs: [
                { left: "SSIAP 1", right: "Intervention et rondes" },
                { left: "SSIAP 2", right: "Management d'√©quipe" },
                { left: "SSIAP 3", right: "Direction du service" }
            ],
            explanation: "Chaque niveau a un p√©rim√®tre de responsabilit√© croissant.",
            timeLimit: 60,
            points: 120
        },
        // R√©glementation et S√©curit√© (5 questions vari√©es)
        {
            type: "quiz",
            title: "Code Construction",
            icon: "üìú",
            color: "from-orange-500 to-yellow-600",
            question: "Le r√®glement de s√©curit√© des ERP est annex√© √† :",
            options: [
                "Le Code de la Construction et de l'Habitation",
                "Le Code du Travail",
                "Le Code P√©nal",
                "Le Code Civil"
            ],
            correctAnswer: 0,
            explanation: "Le r√®glement de s√©curit√© incendie des ERP est annex√© au Code de la Construction et de l'Habitation.",
            timeLimit: 45,
            points: 100
        },
        {
            type: "matching",
            title: "Sigles R√©glementaires",
            icon: "üìú",
            color: "from-orange-500 to-yellow-600",
            question: "Associez chaque sigle avec sa signification :",
            pairs: [
                { left: "ERP", right: "√âtablissement Recevant du Public" },
                { left: "IGH", right: "Immeuble de Grande Hauteur" },
                { left: "ICPE", right: "Installation Class√©e Protection Environnement" },
                { left: "DUER", right: "Document Unique √âvaluation Risques" }
            ],
            explanation: "Ces sigles r√©glementaires sont fondamentaux pour le SSIAP 3.",
            timeLimit: 60,
            points: 120
        },
        {
            type: "quiz",
            title: "IGH",
            icon: "üìú",
            color: "from-orange-500 to-yellow-600",
            question: "Un IGH (Immeuble de Grande Hauteur) a une hauteur sup√©rieure √† :",
            options: [
                "50 m√®tres (plancher bas dernier niveau)",
                "30 m√®tres",
                "100 m√®tres",
                "28 m√®tres"
            ],
            correctAnswer: 0,
            explanation: "Un IGH est d√©fini par une hauteur > 50m pour les habitations ou > 28m pour les autres b√¢timents.",
            timeLimit: 40,
            points: 100
        },
        {
            type: "sequence",
            title: "Hi√©rarchie Commissions",
            icon: "üìú",
            color: "from-orange-500 to-yellow-600",
            question: "Ordre hi√©rarchique des commissions de s√©curit√© (du local au national) :",
            items: [
                "Commission communale",
                "Commission d'arrondissement",
                "Commission d√©partementale",
                "Commission nationale"
            ],
            explanation: "Les commissions de s√©curit√© suivent une organisation territoriale.",
            timeLimit: 60,
            points: 120
        },
        {
            type: "quiz",
            title: "Pouvoir Police",
            icon: "üìú",
            color: "from-orange-500 to-yellow-600",
            question: "Le pouvoir de police administrative en mati√®re de s√©curit√© incendie appartient √† :",
            options: [
                "Le maire (ou le pr√©fet)",
                "Le chef d'√©tablissement",
                "Le SSIAP 3",
                "Les sapeurs-pompiers"
            ],
            correctAnswer: 0,
            explanation: "Le maire d√©tient le pouvoir de police administrative en mati√®re de s√©curit√© incendie (le pr√©fet pour les ERP de 1√®re cat√©gorie).",
            timeLimit: 45,
            points: 100
        },
        // Responsabilit√©s et Missions (10 questions vari√©es)
        {
            type: "true-false",
            title: "Responsabilit√© Finale",
            icon: "‚öñÔ∏è",
            color: "from-purple-500 to-pink-700",
            question: "Le chef d'√©tablissement reste toujours le seul responsable de la s√©curit√© ?",
            options: ["Vrai", "Faux"],
            correctAnswer: 0,
            explanation: "VRAI - M√™me avec d√©l√©gation, le chef d'√©tablissement garde la responsabilit√© finale.",
            timeLimit: 30,
            points: 100
        },
        {
            type: "quiz-multi",
            title: "Missions Budg√©taires",
            icon: "üí∞",
            color: "from-green-500 to-emerald-700",
            question: "Quelles t√¢ches budg√©taires rel√®vent du SSIAP 3 ? (Plusieurs r√©ponses)",
            options: [
                "Proposer le budget du service",
                "G√©rer les d√©penses courantes",
                "Suivre les investissements mat√©riels",
                "Valider les budgets nationaux",
                "Acheter des terrains"
            ],
            correctAnswers: [0, 1, 2],
            explanation: "Le SSIAP 3 propose, g√®re et suit le budget du service de s√©curit√©.",
            timeLimit: 70,
            points: 150
        },
        {
            type: "true-false",
            title: "Formation",
            icon: "üìö",
            color: "from-blue-500 to-indigo-700",
            question: "Le SSIAP 3 peut former les SSIAP 1 et SSIAP 2 ?",
            options: ["Vrai", "Faux"],
            correctAnswer: 0,
            explanation: "VRAI - Il assure la formation continue de son √©quipe (SSIAP 1 et 2).",
            timeLimit: 30,
            points: 100
        },
        {
            type: "quiz-multi",
            title: "Responsabilit√©s RH",
            icon: "üë•",
            color: "from-cyan-500 to-blue-700",
            question: "Le SSIAP 3 intervient dans : (Plusieurs r√©ponses)",
            options: [
                "Recrutement des agents",
                "Formation continue",
                "√âvaluation des agents",
                "D√©finition des profils de poste",
                "Gestion de la paie"
            ],
            correctAnswers: [0, 1, 2, 3],
            explanation: "Le SSIAP 3 g√®re les aspects RH du service sauf la paie qui rel√®ve de l'administration.",
            timeLimit: 70,
            points: 150
        },
        {
            type: "true-false",
            title: "D√©cision Fermeture",
            icon: "üö´",
            color: "from-red-500 to-rose-700",
            question: "Le SSIAP 3 peut d√©cider seul de fermer l'√©tablissement ?",
            options: ["Vrai", "Faux"],
            correctAnswer: 1,
            explanation: "FAUX - Seul le maire (ou pr√©fet) peut ordonner la fermeture. Le SSIAP 3 peut conseiller.",
            timeLimit: 30,
            points: 100
        },
        {
            type: "true-false",
            title: "Commission S√©curit√©",
            icon: "üèõÔ∏è",
            color: "from-orange-500 to-red-600",
            question: "Le SSIAP 3 assiste le chef d'√©tablissement lors des visites de la commission de s√©curit√© ?",
            options: ["Vrai", "Faux"],
            correctAnswer: 0,
            explanation: "VRAI - Il accompagne et assiste le chef d'√©tablissement lors des visites de commission.",
            timeLimit: 30,
            points: 100
        },
        {
            type: "sequence",
            title: "Proc√©dure Commission",
            icon: "üèõÔ∏è",
            color: "from-orange-500 to-red-600",
            question: "√âtapes d'une visite de commission de s√©curit√© :",
            items: [
                "Pr√©paration des documents",
                "Visite de l'√©tablissement",
                "R√©daction du proc√®s-verbal",
                "Notification des prescriptions"
            ],
            explanation: "Cette proc√©dure garantit un contr√¥le m√©thodique de la s√©curit√©.",
            timeLimit: 60,
            points: 120
        },
        {
            type: "true-false",
            title: "Registre S√©curit√©",
            icon: "üìñ",
            color: "from-yellow-500 to-orange-600",
            question: "Le registre de s√©curit√© doit √™tre tenu √† jour par le SSIAP 3 ?",
            options: ["Vrai", "Faux"],
            correctAnswer: 0,
            explanation: "VRAI - Le SSIAP 3 veille √† la tenue √† jour du registre de s√©curit√©.",
            timeLimit: 30,
            points: 100
        },
        {
            type: "quiz-multi",
            title: "Documents du Service",
            icon: "üìñ",
            color: "from-yellow-500 to-orange-600",
            question: "Quels documents le SSIAP 3 doit-il g√©rer ? (Plusieurs r√©ponses)",
            options: [
                "Registre de s√©curit√©",
                "Plans d'intervention",
                "Consignes de s√©curit√©",
                "Rapports d'intervention",
                "Factures √©lectriques"
            ],
            correctAnswers: [0, 1, 2, 3],
            explanation: "Le SSIAP 3 g√®re tous les documents relatifs √† la s√©curit√© incendie.",
            timeLimit: 70,
            points: 150
        },
        {
            type: "quiz-multi",
            title: "Relations Externes",
            icon: "ü§ù",
            color: "from-teal-500 to-cyan-700",
            question: "Avec qui le SSIAP 3 est-il en relation ? (Plusieurs r√©ponses)",
            options: [
                "Commission de s√©curit√©",
                "SDIS (pompiers)",
                "Mairie/Pr√©fecture",
                "Bureaux de contr√¥le",
                "Services de livraison"
            ],
            correctAnswers: [0, 1, 2, 3],
            explanation: "Le SSIAP 3 est l'interface entre l'√©tablissement et toutes les autorit√©s de s√©curit√©.",
            timeLimit: 70,
            points: 150
        }
    ]
};

// Navigation
function showScreen(screenId) {
    document.querySelectorAll('body > div').forEach(div => div.classList.add('hidden'));
    document.getElementById(screenId)?.classList.remove('hidden');
}

function showLoginScreen() {
    showScreen('login-screen');
}

function showSupervisorLogin() {
    showScreen('supervisor-login');
}

function showTraineeLogin() {
    showScreen('trainee-login');
}

// Connexion Superviseur
function loginSupervisor() {
    const password = document.getElementById('supervisor-password').value;
    const errorDiv = document.getElementById('supervisor-error');

    if (password === SUPERVISOR_PASSWORD) {
        userRole = 'supervisor';
        createSession();
    } else {
        errorDiv.textContent = 'Mot de passe incorrect';
        errorDiv.classList.remove('hidden');
    }
}

function createSession() {
    sessionId = 'cup_ssiap_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    console.log('üî• Cr√©ation session:', sessionId);

    database.ref('sessions/' + sessionId).set({
        type: 'cup_ssiap',
        supervisor: 'admin',
        createdAt: Date.now(),
        status: 'waiting',
        teams: {},
        currentGameIndex: 0,
        totalGames: 20  // Mise √† jour : 20 questions par niveau
    }).then(() => {
        console.log('‚úÖ Session cr√©√©e');
        showScreen('supervisor-dashboard');
        loadTeamsList();
        generateQRCode();
    }).catch((error) => {
        console.error('‚ùå Erreur:', error);
    });
}

// G√©n√©rer le QR code pour connexion stagiaires
function generateQRCode() {
    const qrContainer = document.getElementById('qrcode-container');
    if (!qrContainer) return;

    qrContainer.innerHTML = '';
    const traineeUrl = window.location.href.split('?')[0];

    new QRCode(qrContainer, {
        text: traineeUrl,
        width: 256,
        height: 256,
        colorDark: '#5D5CDE',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
    });
}

// Cr√©er une √©quipe
function addTeam() {
    const teamNameInput = document.getElementById('team-name').value.trim();
    const level = parseInt(document.getElementById('team-level').value);

    if (!teamNameInput) {
        return;
    }

    if (!sessionId) {
        return;
    }

    const teamIdNew = 'team_' + Date.now();
    const pinCode = Math.floor(100000 + Math.random() * 900000).toString();

    const newTeam = {
        id: teamIdNew,
        name: teamNameInput,
        level: level,
        pinCode: pinCode,
        score: 0,
        hasAnswered: false,
        answer: null,
        isCorrect: false,
        lastPoints: 0,
        joinedAt: Date.now()
    };

    database.ref('sessions/' + sessionId + '/teams/' + teamIdNew).set(newTeam).then(() => {
        console.log('‚úÖ √âquipe cr√©√©e:', teamNameInput);
        document.getElementById('team-name').value = '';

        // Afficher le PIN
        showPinModal(newTeam);
    });
}

function showPinModal(team) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white/10 backdrop-blur-lg p-8 rounded-3xl border border-white/20 max-w-md w-full">
            <h3 class="text-3xl font-bold mb-4 text-center">‚úÖ √âquipe cr√©√©e</h3>
            <div class="bg-white/20 p-6 rounded-2xl mb-6">
                <p class="text-lg text-center mb-2">Code PIN pour</p>
                <p class="text-2xl font-bold text-center mb-4">${team.name}</p>
                <div class="bg-white/30 p-4 rounded-xl mb-4">
                    <p class="text-5xl font-bold text-center tracking-widest">${team.pinCode}</p>
                </div>
                <div class="flex gap-3">
                    <input type="email" id="pin-email-${team.id}" placeholder="Email du stagiaire" class="flex-1 px-4 py-2 rounded-xl bg-white/20 border border-white/30 text-white placeholder-white/50 text-sm">
                    <button onclick="sendPinByEmail('${team.id}', '${team.name}', '${team.pinCode}')" class="bg-blue-500 px-4 py-2 rounded-xl font-semibold hover:bg-blue-600 text-sm">
                        üìß Envoyer
                    </button>
                </div>
                <div id="email-status-${team.id}" class="mt-2 text-sm text-center"></div>
            </div>
            <button onclick="this.closest('.fixed').remove()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 px-6 py-3 rounded-xl font-bold">
                J'ai not√© le code
            </button>
        </div>
    `;
    document.body.appendChild(modal);
}

// Envoyer le PIN par email
function sendPinByEmail(teamId, teamName, pinCode) {
    const emailInput = document.getElementById('pin-email-' + teamId);
    const statusDiv = document.getElementById('email-status-' + teamId);
    const email = emailInput.value.trim();

    if (!email || !email.includes('@')) {
        statusDiv.textContent = '‚ùå Email invalide';
        statusDiv.className = 'mt-2 text-sm text-center text-red-400';
        return;
    }

    statusDiv.textContent = '‚è≥ Envoi en cours...';
    statusDiv.className = 'mt-2 text-sm text-center text-yellow-400';

    const traineeUrl = window.location.href.split('?')[0];

    const emailBody = `Bonjour,

Vous avez √©t√© ajout√© √† l'√©quipe "${teamName}" pour le Challenge Cup SSIAP.

Votre code PIN de connexion : ${pinCode}

Pour rejoindre le jeu :
1. Allez sur : ${traineeUrl}
2. Cliquez sur "Stagiaire"
3. Entrez le code PIN : ${pinCode}

Bonne chance !

---
Challenge Cup SSIAP - Formation`;

    // Utiliser mailto pour ouvrir le client email
    const mailtoLink = 'mailto:' + encodeURIComponent(email) +
                       '?subject=' + encodeURIComponent('Code PIN - Challenge Cup SSIAP') +
                       '&body=' + encodeURIComponent(emailBody);

    window.open(mailtoLink);

    statusDiv.textContent = '‚úÖ Client email ouvert';
    statusDiv.className = 'mt-2 text-sm text-center text-green-400';
}

function showErrorModal(message) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white/10 backdrop-blur-lg p-8 rounded-3xl border border-white/20 max-w-md w-full">
            <h3 class="text-3xl font-bold mb-4 text-center text-red-400">‚ö†Ô∏è Attention</h3>
            <p class="text-lg text-center mb-6">${message}</p>
            <button onclick="this.closest('.fixed').remove()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 px-6 py-3 rounded-xl font-bold">
                OK
            </button>
        </div>
    `;
    document.body.appendChild(modal);
}

function loadTeamsList() {
    if (!sessionId) return;

    database.ref('sessions/' + sessionId + '/teams').on('value', (snapshot) => {
        const teams = snapshot.val();
        const container = document.getElementById('teams-list');

        if (!teams) {
            container.innerHTML = '<p class="text-center text-purple-200">Aucune √©quipe</p>';
            return;
        }

        const teamsArray = Object.values(teams);
        container.innerHTML = teamsArray.map(team => `
            <div class="bg-white/20 p-4 rounded-xl flex justify-between items-center">
                <div>
                    <div class="font-bold text-lg">${team.name}</div>
                    <div class="text-sm text-purple-200">SSIAP ${team.level} ‚Ä¢ PIN: ${team.pinCode} ‚Ä¢ Score: ${team.score} pts</div>
                </div>
                <button onclick="deleteTeam('${team.id}')" class="bg-red-500 px-4 py-2 rounded-lg font-semibold hover:bg-red-600">
                    Supprimer
                </button>
            </div>
        `).join('');
    });
}

function deleteTeam(teamId) {
    if (!sessionId) return;
    database.ref('sessions/' + sessionId + '/teams/' + teamId).remove();
}

// Connexion Stagiaire
function loginTrainee() {
    const pin = document.getElementById('trainee-pin').value.trim();
    const errorDiv = document.getElementById('trainee-error');

    if (!pin || pin.length !== 6) {
        errorDiv.textContent = 'Code PIN invalide';
        errorDiv.classList.remove('hidden');
        return;
    }

    console.log('üîç Recherche PIN:', pin);

    database.ref('sessions').once('value', (snapshot) => {
        const sessions = snapshot.val();
        if (!sessions) {
            errorDiv.textContent = 'Aucune session active';
            errorDiv.classList.remove('hidden');
            return;
        }

        let foundTeam = null;
        let foundSessionId = null;

        Object.entries(sessions).forEach(([sessId, session]) => {
            if (session.type === 'cup_ssiap' && session.teams) {
                Object.values(session.teams).forEach(team => {
                    if (String(team.pinCode) === String(pin)) {
                        foundTeam = team;
                        foundSessionId = sessId;
                    }
                });
            }
        });

        if (!foundTeam) {
            errorDiv.textContent = 'Code PIN invalide';
            errorDiv.classList.remove('hidden');
            return;
        }

        console.log('‚úÖ √âquipe trouv√©e:', foundTeam.name);
        sessionId = foundSessionId;
        userRole = 'trainee';
        teamId = foundTeam.id;
        teamName = foundTeam.name;

        enableTraineeScrollProtection();
        listenForGameUpdates();
        showScreen('trainee-waiting');
    });
}

function enableTraineeScrollProtection() {
    document.body.classList.add('trainee-connected');
    console.log('üîí Protection scroll activ√©e');
}

// D√©marrer le jeu
function startGame() {
    if (!sessionId) return;

    database.ref('sessions/' + sessionId + '/teams').once('value', (snapshot) => {
        const teams = snapshot.val();
        if (!teams || Object.keys(teams).length === 0) {
            showErrorModal('Ajoutez au moins une √©quipe avant de d√©marrer');
            return;
        }

        // R√©cup√©rer le niveau de la premi√®re √©quipe
        const firstTeam = Object.values(teams)[0];
        const level = firstTeam.level;

        // G√©n√©rer et m√©langer les questions
        const allGames = [];
        const boxesForLevel = BOXES_DATA[level] || [];

        // Pour simplifier, prenons 7 questions al√©atoires
        // TODO: Impl√©menter m√©lange complet comme dans qcm-sst

        database.ref('sessions/' + sessionId).update({
            status: 'playing',
            currentGameIndex: 0,
            level: level
        }).then(() => {
            console.log('üéÆ Jeu d√©marr√©');
            loadGame();
        });
    });
}

// Listener pour les mises √† jour (stagiaires)
function listenForGameUpdates() {
    if (!sessionId) return;

    // √âcouter le statut de la session
    database.ref('sessions/' + sessionId + '/status').on('value', (snapshot) => {
        const status = snapshot.val();
        console.log('üìä Status session:', status);

        if (status === 'playing') {
            // √âcouter en permanence le gameStatus
            database.ref('sessions/' + sessionId + '/gameStatus').on('value', (gameSnapshot) => {
                const gameStatus = gameSnapshot.val();
                console.log('üéÆ Game status:', gameStatus);

                // Charger aussi le currentGameIndex
                database.ref('sessions/' + sessionId + '/currentGameIndex').once('value', (indexSnapshot) => {
                    currentGameIndex = indexSnapshot.val() || 0;
                    console.log('üìù Current game index:', currentGameIndex);
                });

                if (gameStatus === 'question') {
                    showTraineeAnswerScreen();
                } else if (gameStatus === 'correction') {
                    showTraineeResultScreen();
                }
            });
        }
    });
}

function showTraineeAnswerScreen() {
    database.ref('sessions/' + sessionId + '/currentGame').once('value', (snapshot) => {
        const game = snapshot.val();
        if (!game) return;

        showScreen('trainee-answer');

        // Obtenir le nombre total de questions pour le niveau actuel
        database.ref('sessions/' + sessionId + '/level').once('value', (levelSnapshot) => {
            const level = levelSnapshot.val() || 1;
            const totalQuestions = BOXES_DATA[level]?.length || 20;
            document.getElementById('trainee-total-questions').textContent = totalQuestions;
        });

        document.getElementById('trainee-question-num').textContent = currentGameIndex + 1;

        const container = document.getElementById('trainee-options');
        const gameType = game.type || 'quiz';

        // R√©initialiser les variables
        selectedAnswer = null;
        selectedAnswers = [];
        matchingPairs = [];
        sequenceOrder = [];
        selectedLeft = null;
        selectedRight = null;

        // Afficher selon le type de jeu
        if (gameType === 'matching') {
            // Interface matching pour stagiaires
            const shuffledLeft = [...game.pairs].sort(() => Math.random() - 0.5);
            const shuffledRight = [...game.pairs].map(p => p.right).sort(() => Math.random() - 0.5);

            container.innerHTML = `
                <div class="matching-container">
                    <div class="space-y-2" id="matching-left">
                        ${shuffledLeft.map((pair, index) => `
                            <button onclick="selectMatchingLeft(${index}, '${pair.left.replace(/'/g, "\\'")}', '${pair.right.replace(/'/g, "\\'")}')"
                                class="matching-item w-full bg-white/20 p-3 rounded-xl border-2 border-white/30 text-left" data-left="${index}">
                                ${index + 1}. ${pair.left}
                            </button>
                        `).join('')}
                    </div>
                    <div class="space-y-2" id="matching-right">
                        ${shuffledRight.map((right, index) => `
                            <button onclick="selectMatchingRight(${index}, '${right.replace(/'/g, "\\'")}')"
                                class="matching-item w-full bg-white/20 p-3 rounded-xl border-2 border-white/30 text-left" data-right="${index}">
                                ${String.fromCharCode(65 + index)}. ${right}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        } else if (gameType === 'sequence') {
            // Interface sequence pour stagiaires
            const shuffledItems = [...game.items].map((item, index) => ({item, originalIndex: index})).sort(() => Math.random() - 0.5);
            sequenceOrder = shuffledItems.map(s => s.originalIndex);

            container.innerHTML = `
                <div class="space-y-2" id="sequence-container">
                    ${shuffledItems.map((s, index) => `
                        <div class="sequence-item bg-white/20 p-4 rounded-xl border-2 border-white/30 cursor-move flex justify-between items-center" data-index="${index}">
                            <span>${s.item}</span>
                            <div class="flex gap-2">
                                <button onclick="moveSequenceUp(${index})" class="bg-blue-500 px-3 py-1 rounded" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                                <button onclick="moveSequenceDown(${index})" class="bg-blue-500 px-3 py-1 rounded" ${index === shuffledItems.length - 1 ? 'disabled' : ''}>‚Üì</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } else if (gameType === 'quiz-multi') {
            // Interface quiz-multi pour stagiaires
            container.innerHTML = game.options.map((option, index) => `
                <label class="checkbox-option flex items-center bg-white/20 p-4 rounded-xl border-2 border-white/30 cursor-pointer hover:bg-white/30 transition">
                    <input type="checkbox" onchange="toggleMultiAnswer(${index})" class="mr-3" data-index="${index}">
                    <span class="text-lg">${String.fromCharCode(65 + index)}. ${option}</span>
                </label>
            `).join('');
        } else {
            // Interface standard pour quiz et true-false
            container.innerHTML = game.options.map((option, index) => `
                <button onclick="selectAnswer(${index})" class="option-btn px-6 py-4 rounded-xl font-bold text-lg transition hover:scale-105 bg-white/20 border-2 border-white/30" data-index="${index}">
                    ${String.fromCharCode(65 + index)}. ${option}
                </button>
            `).join('');
        }

        document.getElementById('trainee-submit-btn').disabled = true;

        // Charger le score
        loadTeamScore();

        // Timer
        startTraineeTimer(game.timeLimit || 30);
    });
}

function selectAnswer(index) {
    selectedAnswer = index;

    document.querySelectorAll('.option-btn').forEach((btn, i) => {
        if (i === index) {
            btn.classList.add('bg-blue-500', 'border-blue-300');
            btn.classList.remove('bg-white/20', 'border-white/30');
        } else {
            btn.classList.remove('bg-blue-500', 'border-blue-300');
            btn.classList.add('bg-white/20', 'border-white/30');
        }
    });

    document.getElementById('trainee-submit-btn').disabled = false;
}

// Fonctions pour quiz-multi
function toggleMultiAnswer(index) {
    if (selectedAnswers.includes(index)) {
        selectedAnswers = selectedAnswers.filter(i => i !== index);
    } else {
        selectedAnswers.push(index);
    }
    document.getElementById('trainee-submit-btn').disabled = selectedAnswers.length === 0;
}

// Fonctions pour matching
function selectMatchingLeft(index, left, right) {
    selectedLeft = {index, left, right};

    // Highlight
    document.querySelectorAll('[data-left]').forEach((btn, i) => {
        if (i === index) {
            btn.classList.add('selected', 'bg-blue-500');
            btn.classList.remove('bg-white/20');
        } else {
            btn.classList.remove('selected', 'bg-blue-500');
            btn.classList.add('bg-white/20');
        }
    });

    if (selectedRight !== null) {
        createMatchingPair();
    }
}

function selectMatchingRight(index, right) {
    selectedRight = {index, right};

    // Highlight
    document.querySelectorAll('[data-right]').forEach((btn, i) => {
        if (i === index) {
            btn.classList.add('selected', 'bg-blue-500');
            btn.classList.remove('bg-white/20');
        } else {
            btn.classList.remove('selected', 'bg-blue-500');
            btn.classList.add('bg-white/20');
        }
    });

    if (selectedLeft !== null) {
        createMatchingPair();
    }
}

function createMatchingPair() {
    if (!selectedLeft || !selectedRight) return;

    matchingPairs.push({
        left: selectedLeft.left,
        right: selectedRight.right,
        correctRight: selectedLeft.right
    });

    // Marquer comme matched
    document.querySelector(`[data-left="${selectedLeft.index}"]`).classList.add('matched');
    document.querySelector(`[data-right="${selectedRight.index}"]`).classList.add('matched');

    selectedLeft = null;
    selectedRight = null;

    // V√©rifier si toutes les paires sont cr√©√©es
    database.ref('sessions/' + sessionId + '/currentGame').once('value', (snapshot) => {
        const game = snapshot.val();
        if (matchingPairs.length === game.pairs.length) {
            document.getElementById('trainee-submit-btn').disabled = false;
        }
    });
}

// Fonctions pour sequence
function moveSequenceUp(index) {
    if (index === 0) return;

    const temp = sequenceOrder[index];
    sequenceOrder[index] = sequenceOrder[index - 1];
    sequenceOrder[index - 1] = temp;

    refreshSequenceDisplay();
    document.getElementById('trainee-submit-btn').disabled = false;
}

function moveSequenceDown(index) {
    if (index === sequenceOrder.length - 1) return;

    const temp = sequenceOrder[index];
    sequenceOrder[index] = sequenceOrder[index + 1];
    sequenceOrder[index + 1] = temp;

    refreshSequenceDisplay();
    document.getElementById('trainee-submit-btn').disabled = false;
}

function refreshSequenceDisplay() {
    database.ref('sessions/' + sessionId + '/currentGame').once('value', (snapshot) => {
        const game = snapshot.val();
        const container = document.getElementById('sequence-container');

        container.innerHTML = sequenceOrder.map((originalIndex, index) => `
            <div class="sequence-item bg-white/20 p-4 rounded-xl border-2 border-white/30 cursor-move flex justify-between items-center" data-index="${index}">
                <span>${game.items[originalIndex]}</span>
                <div class="flex gap-2">
                    <button onclick="moveSequenceUp(${index})" class="bg-blue-500 px-3 py-1 rounded" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                    <button onclick="moveSequenceDown(${index})" class="bg-blue-500 px-3 py-1 rounded" ${index === sequenceOrder.length - 1 ? 'disabled' : ''}>‚Üì</button>
                </div>
            </div>
        `).join('');
    });
}

function submitAnswer() {
    if (!sessionId || !teamId) return;

    database.ref('sessions/' + sessionId + '/currentGame').once('value', (snapshot) => {
        const game = snapshot.val();
        if (!game) return;

        const gameType = game.type || 'quiz';
        let isCorrect = false;
        let answerData = null;

        // Valider selon le type de jeu
        if (gameType === 'quiz' || gameType === 'true-false') {
            if (selectedAnswer === null) return;
            isCorrect = selectedAnswer === game.correctAnswer;
            answerData = selectedAnswer;
        } else if (gameType === 'quiz-multi') {
            if (selectedAnswers.length === 0) return;
            // V√©rifier que toutes les bonnes r√©ponses sont s√©lectionn√©es et aucune mauvaise
            const correctSet = new Set(game.correctAnswers);
            const selectedSet = new Set(selectedAnswers);

            isCorrect = correctSet.size === selectedSet.size &&
                        [...correctSet].every(x => selectedSet.has(x));
            answerData = selectedAnswers;
        } else if (gameType === 'matching') {
            if (matchingPairs.length !== game.pairs.length) return;
            // V√©rifier que toutes les paires sont correctes
            isCorrect = matchingPairs.every(pair => pair.right === pair.correctRight);
            answerData = matchingPairs;
        } else if (gameType === 'sequence') {
            // V√©rifier que l'ordre est correct
            isCorrect = sequenceOrder.every((val, index) => val === index);
            answerData = sequenceOrder;
        }

        const points = isCorrect ? (game.points || 100) : 0;

        const updates = {};
        updates['sessions/' + sessionId + '/teams/' + teamId + '/hasAnswered'] = true;
        updates['sessions/' + sessionId + '/teams/' + teamId + '/answer'] = JSON.stringify(answerData);
        updates['sessions/' + sessionId + '/teams/' + teamId + '/isCorrect'] = isCorrect;
        updates['sessions/' + sessionId + '/teams/' + teamId + '/lastPoints'] = points;

        if (isCorrect) {
            updates['sessions/' + sessionId + '/teams/' + teamId + '/score'] = firebase.database.ServerValue.increment(points);
        }

        database.ref().update(updates).then(() => {
            console.log('‚úÖ R√©ponse envoy√©e');

            // Incr√©menter le compteur de r√©ponses
            database.ref('sessions/' + sessionId + '/answersCount').transaction((current) => {
                return (current || 0) + 1;
            });
        });
    });
}

function loadTeamScore() {
    if (!sessionId || !teamId) return;

    database.ref('sessions/' + sessionId + '/teams/' + teamId).once('value', (snapshot) => {
        const team = snapshot.val();
        if (team) {
            document.getElementById('trainee-team-name').textContent = team.name;
            document.getElementById('trainee-score').textContent = team.score || 0;
        }
    });
}

function startTraineeTimer(seconds) {
    if (timerInterval) clearInterval(timerInterval);

    let timeLeft = seconds;
    const timerEl = document.getElementById('trainee-timer');

    timerInterval = setInterval(() => {
        timeLeft--;
        timerEl.textContent = timeLeft;

        if (timeLeft <= 10) {
            timerEl.classList.add('timer-warning', 'text-red-500');
        }

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
        }
    }, 1000);
}

function showTraineeResultScreen() {
    showScreen('trainee-result');

    database.ref('sessions/' + sessionId + '/teams/' + teamId).once('value', (snapshot) => {
        const team = snapshot.val();
        if (!team) return;

        const points = team.lastPoints || 0;
        const hasAnswered = team.hasAnswered;

        if (!hasAnswered) {
            document.getElementById('trainee-result-icon').textContent = '‚è∞';
            document.getElementById('trainee-result-title').textContent = 'Temps √©coul√© !';
            document.getElementById('trainee-result-title').className = 'text-5xl font-bold mb-6 text-orange-400';
            document.getElementById('trainee-result-points').textContent = '0';
        } else if (points > 0) {
            document.getElementById('trainee-result-icon').textContent = '‚úì';
            document.getElementById('trainee-result-title').textContent = 'Bonne r√©ponse !';
            document.getElementById('trainee-result-title').className = 'text-5xl font-bold mb-6 text-green-400';
            document.getElementById('trainee-result-points').textContent = '+' + points;
        } else {
            document.getElementById('trainee-result-icon').textContent = '‚úó';
            document.getElementById('trainee-result-title').textContent = 'Mauvaise r√©ponse';
            document.getElementById('trainee-result-title').className = 'text-5xl font-bold mb-6 text-red-400';
            document.getElementById('trainee-result-points').textContent = '0';
        }

        document.getElementById('trainee-result-total').textContent = team.score || 0;
    });
}

// Charger une question
function loadGame() {
    if (!sessionId) return;

    console.log('üéÆ Chargement question', currentGameIndex);

    // R√©initialiser les flags de r√©ponse
    database.ref('sessions/' + sessionId + '/teams').once('value', (snapshot) => {
        const teams = snapshot.val();
        if (!teams) return;

        const updates = {};
        Object.keys(teams).forEach(id => {
            updates['sessions/' + sessionId + '/teams/' + id + '/hasAnswered'] = false;
            updates['sessions/' + sessionId + '/teams/' + id + '/answer'] = null;
            updates['sessions/' + sessionId + '/teams/' + id + '/isCorrect'] = false;
            updates['sessions/' + sessionId + '/teams/' + id + '/lastPoints'] = 0;
        });

        return database.ref().update(updates);
    }).then(() => {
        // Charger la question
        database.ref('sessions/' + sessionId + '/level').once('value', (snapshot) => {
            const level = snapshot.val() || 1;
            const questions = BOXES_DATA[level] || BOXES_DATA[1];
            const game = questions[currentGameIndex];

            if (!game) {
                // Fin du jeu
                showFinalScreen();
                return;
            }

            // Sauvegarder la question actuelle
            database.ref('sessions/' + sessionId).update({
                currentGame: game,
                currentGameIndex: currentGameIndex,
                gameStatus: 'question',
                answersCount: 0,
                questionTimestamp: Date.now()
            }).then(() => {
                if (userRole === 'supervisor') {
                    showProjectorQuestion(game);
                    startProjectorTimer(game.timeLimit || 30);
                    startAnswersCountListener();
                }
            });
        });
    });
}

// Afficher la question sur le projecteur
function showProjectorQuestion(game) {
    showScreen('projector-screen');

    // Obtenir le nombre total de questions pour le niveau actuel
    database.ref('sessions/' + sessionId + '/level').once('value', (snapshot) => {
        const level = snapshot.val() || 1;
        const totalQuestions = BOXES_DATA[level]?.length || 20;
        document.getElementById('projector-total-questions').textContent = totalQuestions;

        const progress = ((currentGameIndex + 1) / totalQuestions) * 100;
        document.getElementById('projector-progress').style.width = progress + '%';
    });

    document.getElementById('projector-question-num').textContent = currentGameIndex + 1;
    document.getElementById('projector-box-name').textContent = game.title;
    document.getElementById('projector-question-title').textContent = game.title + ' ' + game.icon;
    document.getElementById('projector-question-text').textContent = game.question;

    // NE PAS AFFICHER LES OPTIONS SUR LE PROJECTEUR
    // Les r√©ponses sont uniquement sur l'√©cran des stagiaires
    const container = document.getElementById('projector-options');
    container.innerHTML = `
        <div class="text-center p-8">
            <p class="text-2xl text-white/60">Les r√©ponses sont affich√©es sur l'√©cran des stagiaires</p>
        </div>
    `;

    updateTeamsStatus();
}

// Timer projecteur
function startProjectorTimer(seconds) {
    if (timerInterval) clearInterval(timerInterval);

    let timeLeft = seconds;
    const timerEl = document.getElementById('projector-timer');
    timerEl.textContent = timeLeft;
    timerEl.classList.remove('timer-warning', 'text-red-500');

    timerInterval = setInterval(() => {
        timeLeft--;
        timerEl.textContent = timeLeft;

        if (timeLeft <= 10) {
            timerEl.classList.add('timer-warning', 'text-red-500');
        }

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            handleTimeUp();
        }
    }, 1000);
}

// Timeout - marquer les non-r√©pondants
function handleTimeUp() {
    console.log('‚è∞ Temps √©coul√©');

    database.ref('sessions/' + sessionId + '/teams').once('value', (snapshot) => {
        const teams = snapshot.val();
        if (!teams) return;

        const updates = {};
        let nonRespondantsCount = 0;

        Object.entries(teams).forEach(([id, team]) => {
            if (!team.hasAnswered) {
                updates['sessions/' + sessionId + '/teams/' + id + '/hasAnswered'] = true;
                updates['sessions/' + sessionId + '/teams/' + id + '/answer'] = null;
                updates['sessions/' + sessionId + '/teams/' + id + '/isCorrect'] = false;
                nonRespondantsCount++;
            }
        });

        if (Object.keys(updates).length > 0) {
            database.ref().update(updates).then(() => {
                database.ref('sessions/' + sessionId + '/answersCount').transaction((current) => {
                    return (current || 0) + nonRespondantsCount;
                });
            });
        } else {
            // Tout le monde a d√©j√† r√©pondu
            setTimeout(() => showCorrection(), 1000);
        }
    });
}

// √âcouter le compteur de r√©ponses
function startAnswersCountListener() {
    if (answersListener) {
        database.ref('sessions/' + sessionId + '/answersCount').off('value', answersListener);
    }

    answersListener = database.ref('sessions/' + sessionId + '/answersCount').on('value', (snapshot) => {
        const count = snapshot.val() || 0;

        database.ref('sessions/' + sessionId + '/teams').once('value', (teamsSnapshot) => {
            const teams = teamsSnapshot.val();
            const totalTeams = teams ? Object.keys(teams).length : 0;

            document.getElementById('projector-answers-count').textContent = count;
            document.getElementById('projector-teams-count').textContent = totalTeams;

            updateTeamsStatus();

            if (count >= totalTeams && totalTeams > 0) {
                console.log('‚úÖ Toutes les √©quipes ont r√©pondu');
                database.ref('sessions/' + sessionId + '/answersCount').off('value', answersListener);
                answersListener = null;

                if (timerInterval) {
                    clearInterval(timerInterval);
                }

                setTimeout(() => showCorrection(), 2000);
            }
        });
    });
}

// Mettre √† jour le statut des √©quipes
function updateTeamsStatus() {
    if (!sessionId) return;

    database.ref('sessions/' + sessionId + '/teams').once('value', (snapshot) => {
        const teams = snapshot.val();
        if (!teams) return;

        const container = document.getElementById('projector-teams-status');
        container.innerHTML = Object.values(teams).map(team => `
            <div class="bg-white/20 p-3 rounded-xl text-center">
                <div class="font-bold">${team.name}</div>
                <div class="text-sm ${team.hasAnswered ? 'text-green-400' : 'text-yellow-400'}">
                    ${team.hasAnswered ? '‚úì R√©pondu' : '‚è≥ En attente'}
                </div>
            </div>
        `).join('');
    });
}

// Afficher la correction
function showCorrection() {
    if (!sessionId) return;

    database.ref('sessions/' + sessionId).update({
        gameStatus: 'correction'
    });

    database.ref('sessions/' + sessionId + '/currentGame').once('value', (snapshot) => {
        const game = snapshot.val();
        if (!game) return;

        showScreen('correction-screen');

        const gameType = game.type || 'quiz';
        document.getElementById('correction-question').textContent = game.question;

        // Afficher la bonne r√©ponse selon le type
        if (gameType === 'matching') {
            const correctPairs = game.pairs.map(p => `${p.left} ‚Üí ${p.right}`).join(', ');
            document.getElementById('correction-answer').textContent = correctPairs;
        } else if (gameType === 'sequence') {
            const correctOrder = game.items.join(' ‚Üí ');
            document.getElementById('correction-answer').textContent = correctOrder;
        } else if (gameType === 'quiz-multi') {
            const correctOptions = game.correctAnswers.map(i => String.fromCharCode(65 + i) + '. ' + game.options[i]).join(', ');
            document.getElementById('correction-answer').textContent = correctOptions;
        } else {
            // quiz et true-false
            document.getElementById('correction-answer').textContent = game.options[game.correctAnswer];
        }

        document.getElementById('correction-explanation').textContent = game.explanation || '';

        // Afficher le classement
        loadLeaderboard();

        // Confetti pour les bonnes r√©ponses
        createConfetti();
    });
}

// Charger le classement
function loadLeaderboard() {
    database.ref('sessions/' + sessionId + '/teams').once('value', (snapshot) => {
        const teams = snapshot.val();
        if (!teams) return;

        const teamsArray = Object.values(teams).sort((a, b) => b.score - a.score);

        const container = document.getElementById('correction-leaderboard');
        container.innerHTML = teamsArray.map((team, index) => {
            let medal = '';
            if (index === 0) medal = 'ü•á';
            else if (index === 1) medal = 'ü•à';
            else if (index === 2) medal = 'ü•â';

            return `
                <div class="bg-white/20 p-4 rounded-xl flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="text-3xl">${medal || (index + 1) + '.'}</div>
                        <div>
                            <div class="font-bold text-lg">${team.name}</div>
                            <div class="text-sm text-purple-200">SSIAP ${team.level}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-bold">${team.score}</div>
                        <div class="text-sm text-purple-200">points</div>
                    </div>
                </div>
            `;
        }).join('');
    });
}

// Cr√©er des confetti
function createConfetti() {
    const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A'];
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * window.innerWidth + 'px';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 0.5 + 's';
        document.getElementById('confetti-container').appendChild(confetti);
        setTimeout(() => confetti.remove(), 3000);
    }
}

// Question suivante
function nextQuestion() {
    currentGameIndex++;

    database.ref('sessions/' + sessionId + '/level').once('value', (snapshot) => {
        const level = snapshot.val() || 1;
        const questions = BOXES_DATA[level] || BOXES_DATA[1];

        if (currentGameIndex >= questions.length) {
            // Fin du jeu
            showFinalScreen();
        } else {
            loadGame();
        }
    });
}

// √âcran final
function showFinalScreen() {
    database.ref('sessions/' + sessionId).update({
        status: 'finished'
    });

    showScreen('final-screen');

    // Charger le classement final
    database.ref('sessions/' + sessionId + '/teams').once('value', (snapshot) => {
        const teams = snapshot.val();
        if (!teams) return;

        const teamsArray = Object.values(teams).sort((a, b) => b.score - a.score);

        const container = document.getElementById('final-leaderboard');
        container.innerHTML = teamsArray.map((team, index) => {
            let medal = '';
            let bgClass = '';
            if (index === 0) {
                medal = 'ü•á';
                bgClass = 'bg-gradient-to-r from-yellow-500/30 to-orange-500/30 border-yellow-500';
            } else if (index === 1) {
                medal = 'ü•à';
                bgClass = 'bg-gradient-to-r from-gray-400/30 to-gray-500/30 border-gray-400';
            } else if (index === 2) {
                medal = 'ü•â';
                bgClass = 'bg-gradient-to-r from-orange-600/30 to-orange-700/30 border-orange-600';
            } else {
                bgClass = 'bg-white/20 border-white/30';
            }

            return `
                <div class="${bgClass} p-6 rounded-2xl flex justify-between items-center border-2">
                    <div class="flex items-center gap-4">
                        <div class="text-5xl">${medal || (index + 1)}</div>
                        <div>
                            <div class="font-bold text-2xl">${team.name}</div>
                            <div class="text-lg text-purple-200">SSIAP ${team.level}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-5xl font-bold">${team.score}</div>
                        <div class="text-lg text-purple-200">points</div>
                    </div>
                </div>
            `;
        }).join('');
    });

    // Mega confetti
    for (let i = 0; i < 200; i++) {
        setTimeout(() => createConfetti(), i * 20);
    }
}

// Red√©marrer le jeu
function restartGame() {
    if (!sessionId) return;

    // R√©initialiser les scores
    database.ref('sessions/' + sessionId + '/teams').once('value', (snapshot) => {
        const teams = snapshot.val();
        if (!teams) return;

        const updates = {};
        Object.keys(teams).forEach(id => {
            updates['sessions/' + sessionId + '/teams/' + id + '/score'] = 0;
            updates['sessions/' + sessionId + '/teams/' + id + '/hasAnswered'] = false;
            updates['sessions/' + sessionId + '/teams/' + id + '/answer'] = null;
            updates['sessions/' + sessionId + '/teams/' + id + '/isCorrect'] = false;
            updates['sessions/' + sessionId + '/teams/' + id + '/lastPoints'] = 0;
        });

        database.ref().update(updates).then(() => {
            currentGameIndex = 0;
            database.ref('sessions/' + sessionId).update({
                status: 'playing',
                currentGameIndex: 0,
                gameStatus: 'question'
            }).then(() => {
                loadGame();
            });
        });
    });
}

function logout() {
    sessionId = null;
    userRole = null;
    teamId = null;
    teamName = null;
    currentGameIndex = 0;
    if (timerInterval) clearInterval(timerInterval);
    if (answersListener) {
        database.ref('sessions/' + sessionId + '/answersCount').off('value', answersListener);
        answersListener = null;
    }
    showScreen('login-screen');
}

// D√©marrage
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.documentElement.classList.add('dark');
}
</script>

</body>
</html>
